default_platform(:ios)

platform :ios do
  desc "Push a new release to the App Store"
  lane :release_app_store do
    # Load API Key
    api_key = app_store_connect_api_key(
      key_id: "ZWWB48GR96",
      issuer_id: "281d6b58-259e-4b20-aad6-06fb53291bc7",
      key_filepath: "fastlane/AuthKey_ZWWB48GR96.p8",
      duration: 1200, # optional (default 1200)
      in_house: false # optional (default false)
    )

    # 1. Run Unit Tests
    run_tests(
      scheme: "InOfficeDaysTracker",
      device: "iPhone 16",
      only_testing: "InOfficeDaysTrackerTests",
      parallel_testing: false,
      clean: true
    )

    # 2. Increment Build Number using custom script (syncs Main App + Widget Extension)
    sh("../scripts/update_version.sh --increment-build")

    # 3. Build the App
    build_app(
      scheme: "InOfficeDaysTracker",
      workspace: "InOfficeDaysTracker.xcodeproj",
      export_method: "app-store",
      clean: true
    )

    # 4. Upload to App Store (and submit for review!)
    upload_to_app_store(
      api_key: api_key,
      force: true,
      submit_for_review: true,
      automatic_release: false,
      skip_screenshots: true,
      skip_metadata: false,
      precheck_include_in_app_purchases: false
    )
  end

  desc "Submit existing TestFlight build for App Store review"
  lane :submit_for_review do
    # Load API Key
    api_key = app_store_connect_api_key(
      key_id: "ZWWB48GR96",
      issuer_id: "281d6b58-259e-4b20-aad6-06fb53291bc7",
      key_filepath: "fastlane/AuthKey_ZWWB48GR96.p8",
      duration: 1200,
      in_house: false
    )

    # Submit for review without uploading a new binary
    upload_to_app_store(
      api_key: api_key,
      skip_binary_upload: true,      # Don't upload, use existing TestFlight build
      submit_for_review: true,
      automatic_release: false,
      skip_screenshots: true,
      skip_metadata: false,
      precheck_include_in_app_purchases: false
    )
  end
end
